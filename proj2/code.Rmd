---
title: "proj2"
author: "Tuo Liu"
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(survey, tidyverse, DataExplorer, arsenal, survey, gtsummary)
```


### data read-in

```{r}
data <- read.csv("./data/nhanes.csv")
```
- RIDAGEYR - Age in years at screening
- WTINT2YR - Full sample 2 year interview weight
- WTMEC2YR - Full sample 2 year MEC exam weight
- SDMVPSU - Masked variance pseudo-PSU
- SDMVSTRA - Masked variance pseudo-stratum


- SMQ020 - Smoked at least 100 cigarettes in life
- SMQ040 - Do you now smoke cigarettes?
- SMQ900 - Ever used an e-cigarette?
- SMQ905 - How many days used an e-cigarette? During the past 30 days
- SMQ681 - Smoked tobacco last 5 days?
- SMQ690H - Used last 5 days - E-cigarettes
- SMQ720 - # cigarettes smoked per day
- SMQ849 - # days smoked e-cigarette last 5 days
- SMDANY - Used any tobacco product last 5 days?

- LBXBPB - Blood lead (ug/dL)
- BMXBMI - Body Mass Index (kg/m**2)

- ALQ111 - Ever had a drink of any kind of alcohol
- ALQ121 - Past 12 mo how often have alcohol drink
- ALQ130 - Avg # alcohol drinks/day - past 12 mos
- ALQ142 - # days have 4 or 5 drinks/past 12 mos
- ALQ270 - # times 4-5 drinks in 2 hrs/past 12 mos
- ALQ280 - # times 8+ drinks in 1 day/past 12 mos
- ALQ290 - # times 12+ drinks in 1 day/past 12 mos
- ALQ151 - Ever have 4/5 or more drinks every day?
- ALQ170 - Past 30 days # times 4-5 drinks on an oc

### descriptive statistics

Shortly after, each individual will submit descriptive statistics for that plan.
This individual submission should include a very brief discussion of the objectives
of the project and the sample, and identify and define outcomes, the exposure or
treatment and important predictors. One component of the submission is a shell
table that will align with Table 1 in the final report. The submitted shell table is
empty. Individuals also provide code and output (in an Appendix) that could be
used to populate the table (i.e. every item listed in the shell table could be filled
with the provided output). All of this should be submitted in a single document.

```{r results="asis"}
# data <- data %>% select(1:4, 8:11, 16:17, 20, 24:26, 33:34) 

# data prep
data <- data %>% mutate(
            RIDRETH3=factor(RIDRETH3),
            RIAGENDR=factor(RIAGENDR),
            SMQ040=factor(SMQ040),
            SMQ900=factor(SMQ900),
            ALQ111=factor(ALQ111),
            ALQ151=factor(ALQ151)
            )

levels(data$RIAGENDR) <- c("Male", "Female")
levels(data$RIDRETH3) <- c("Mexican American","Other Hispanic", "Non-Hispanic White", "Non-Hispanic Black",
                           "Non-Hispanic Asian", "Other")
levels(data$SMQ040) <- c("Daily", "Sometimes","No")
levels(data$SMQ900) <- c("Yes", "No", "Don't know")
levels(data$ALQ111) <- c("Yes", "No")
levels(data$ALQ151) <- c("Yes", "No", "Refused", "Don't know")





# variabel type
DataExplorer::plot_missing(data)

# descriptive statistics for table 1
# my_labels <- list(
#   SMQ900 = "Ever used e-cigarette",
#   RIAGENDR = "Gender",
#   RIDAGEYR = "Age (yrs)",
#   RIDRETH3 = "Race/Ethnicity",
#   SMQ040 = "Current smoker",
#   SMQ720 = "Num. of cigarette/day",
#   LBXBPB = "Blood lead level (ug/dL)",
#   BMXBMI = "BMI (kg/m2)",
#   ALQ111 = "Ever drink alcohol"
# )
# # attr(data$SEX,'label')  <- 'Gender'
# # attr(data$PERIOD,'label')  <- 'Examination Cycle'
# # attr(data$CVD,'label')  <- 'CVD Status'
# 
# 
# my_controls <- tableby.control(
#   test = T,
#   total = F,
#   numeric.test = "anova", cat.test = "chisq",
#   numeric.stats = c("meansd", "medianq1q3"),
#   cat.stats = c("countpct"),
#   stats.labels = list(
#     meansd = "Mean (SD)",
#     medianq1q3 = "Median (Q1, Q3)"
#   )
# )
# 
# table <- arsenal::tableby(SMQ900 ~  RIAGENDR + RIDAGEYR + RIDRETH3 + SMQ040 + SMQ720 + LBXBPB + BMXBMI + ALQ111, data = data, control = my_controls)
# 
# summary(table,
#   labelTranslations = my_labels,
#   title = "Summary Statistic of Subset of NHANES 2017-2018 Data", 
#   pfootnote=TRUE,
#   results="asis",
#   digits=1
# )
```

### weighted descrptive statistics
```{r}
data <- data %>% dplyr::mutate(SMQ900 = forcats::fct_explicit_na(factor(SMQ900)))
design_m <- svydesign(id=data$SDMVPSU, strata=data$SDMVSTRA, weights = data$WTMEC2YR, data=data, nest=T)

# age among vaping & non-vaping
svyby(~RIDAGEYR, ~SMQ900, design_m, svymean, na.rm = T)

# Num. of cigarette/day among vaping & non-vaping
svyby(~SMQ720, ~SMQ900, design_m, svymean, na.rm = T)

# gender/race/tobacco use/alcohol use
design_m %>%
  tbl_svysummary(by = SMQ900, percent = "col", 
                 include = c(RIAGENDR,RIDRETH3,SMQ040,ALQ151),
                 statistic = list(all_categorical()~"{n_unweighted}/{N_unweighted} ({p_unweighted}%)"),
                 missing = "no"
                 )
```



```{r}
# BMI among vaping & non-vaping
svyby(~BMXBMI, ~SMQ900, design_m, svymean, na.rm = T)
# Bood lead level among vaping & non-vaping
svyby(~LBXBPB, ~SMQ900, design_m, svymean, na.rm = T)
```
```{r}
# LLOD for BLL



```

### vaping-only subpopulation
```{r}
desin_v <- subset(design_m, )
```

