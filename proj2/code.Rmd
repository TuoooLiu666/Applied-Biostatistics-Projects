---
title: "proj2"
author: "Tuo Liu"
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(survey, tidyverse, DataExplorer, arsenal, survey, gtsummary)
```


### data read-in

```{r}
data <- read.csv("./data/nhanes.csv")
# missing
DataExplorer::plot_missing(data)
```
- RIDAGEYR - Age in years at screening
- WTINT2YR - Full sample 2 year interview weight
- WTMEC2YR - Full sample 2 year MEC exam weight
- SDMVPSU - Masked variance pseudo-PSU
- SDMVSTRA - Masked variance pseudo-stratum
- dmdeduc2 - Education level
- dmdmartL - Marital status
- indhhin2 - household income

- SMQ020 - Smoked at least 100 cigarettes in life
- SMQ040 - Do you now smoke cigarettes?
- SMQ900 - Ever used an e-cigarette?
- SMQ905 - How many days used an e-cigarette? During the past 30 days
- SMQ681 - Smoked tobacco last 5 days?
- SMQ690H - Used last 5 days - E-cigarettes
- SMQ720 - # cigarettes smoked per day
- SMQ849 - # days smoked e-cigarette last 5 days
- SMDANY - Used any tobacco product last 5 days?

- LBXBPB - Blood lead (ug/dL)
- BMXBMI - Body Mass Index (kg/m**2)

- ALQ111 - Ever had a drink of any kind of alcohol
- ALQ121 - Past 12 mo how often have alcohol drink
- ALQ130 - Avg # alcohol drinks/day - past 12 mos
- ALQ142 - # days have 4 or 5 drinks/past 12 mos
- ALQ270 - # times 4-5 drinks in 2 hrs/past 12 mos
- ALQ280 - # times 8+ drinks in 1 day/past 12 mos
- ALQ290 - # times 12+ drinks in 1 day/past 12 mos
- ALQ151 - Ever have 4/5 or more drinks every day?
- ALQ170 - Past 30 days # times 4-5 drinks on an oc

### descriptive statistics

Shortly after, each individual will submit descriptive statistics for that plan.
This individual submission should include a very brief discussion of the objectives
of the project and the sample, and identify and define outcomes, the exposure or
treatment and important predictors. One component of the submission is a shell
table that will align with Table 1 in the final report. The submitted shell table is
empty. Individuals also provide code and output (in an Appendix) that could be
used to populate the table (i.e. every item listed in the shell table could be filled
with the provided output). All of this should be submitted in a single document.

```{r results="asis"}
# sum(is.na(data$DMDEDUC2))
# sum(is.na(data$DMDMARTL))
# sum(is.na(data$INDHHIN2))
# sum(is.na(data$ALQ121))
# sum(is.na(data$SMQ905))

# feature engineering
data$merit <- ifelse(data$DMDMARTL %in% c(1,6), 1, ifelse(data$DMDMARTL %in% c(2:5), 2, ifelse(data$DMDMARTL==77, 9, NA)))
data$educ <- ifelse(data$DMDEDUC2 %in% c(1,2)&data$RIDAGEYR>=20|data$DMDEDUC3 %in% c(8,9,10,11,12)&data$RIDAGEYR<20, 1, ifelse(data$DMDEDUC2&data$RIDAGEYR>=20 %in% c(3)|data$DMDEDUC3 %in% c(13,14)&data$RIDAGEYR<20,2,ifelse(data$DMDEDUC2 ==4&data$RIDAGEYR>=20|data$DMDEDUC3==15&data$RIDAGEYR<20,3,ifelse(data$DMDEDUC2 == 5 &data$RIDAGEYR>=20,4,5))))
data$inc <- ifelse(data$INDHHIN2 %in% c(1,2,3,4,5), 1, ifelse(data$INDHHIN2 %in% c(6,7), 2, ifelse(data$INDHHIN2 %in% c(8:10),3, ifelse(data$INDHHIN2 %in% c(14:15), 4, ifelse(data$INDHHIN2 %in% c(77,99, 12,13),9,NA)))))
data$alc <- ifelse(data$ALQ121 == 0, 0, ifelse(data$ALQ121 %in% c(1,2,3,4,5), 1, ifelse(data$ALQ121 %in% c(6:10), 2, ifelse(data$ALQ121 %in% c(77,99), 9, NA))))

data$ecig <- ifelse(data$SMQ905 %in% c(1:30), 1, ifelse(data$SMQ905==0, 0, ifelse(data$SMQ905==99, 9, NA)))


# data prep
data <- data %>% mutate(
            RIDRETH3=factor(RIDRETH3),
            RIAGENDR=factor(RIAGENDR),
            SMQ040=factor(SMQ040),
            SMQ849=factor(SMQ849),
            ALQ121=factor(ALQ121),
            educ=factor(educ),
            merit=factor(merit),
            inc=factor(inc),
            alc=factor(alc),
            ecig=factor(ecig)
            )

levels(data$RIAGENDR) <- c("Male", "Female")
levels(data$RIDRETH3) <- c("Mexican American","Other Hispanic", "Non-Hispanic White", "Non-Hispanic Black","Non-Hispanic Asian", "Other Race")
levels(data$educ) <- c("No High School Diploma", "High School Diploma", "Some College", "College Graduates", "Unknown")
levels(data$inc) <- c("Under 25k", "25k-45k", "45k-75k", "Above 75k", "Unknown")
levels(data$merit) <- c("Married","Single","Unknown")
levels(data$alc) <- c("Non-Drinker", "Drinking 2/week or more","Occasional drinkers","Unknown")
levels(data$ecig) <- c("Non-Smoker", "Smoker", "Unkown")

# sum(is.na(data$merit))
# sum(is.na(data$educ))
# sum(is.na(data$inc))
# sum(is.na(data$alc))
# sum(is.na(data$ecig))
```


### weighted descrptive statistics
```{r results='asis'}
design <- svydesign(id=data$SDMVPSU, strata=data$SDMVSTRA, weights = data$WTMEC2YR, data=data, nest=T)

# subset desing to include subject >= 18
filter <- (!is.na(data$SMQ905))


design_m <- subset(design, filter & SEQN!=99240)


# # age among vaping & non-vaping
# svyby(~RIDAGEYR, ~ecig, design_m, svymean, na.rm = T)
# 
# # BMI among vaping & non-vaping
# svyby(~BMXBMI, ~ecig, design_m, svymean, na.rm = T)
# 
# # Bood lead level among vaping & non-vaping
# svyby(~LBXBPB, ~ecig, design_m, svymean, na.rm = T)
# 
# # Num. of cigarette/day among vaping & non-vaping
# svyby(~SMQ720, ~ecig, design_m, svymean, na.rm = T)

# gender/race/tobacco use/alcohol use
design_m %>%
  tbl_svysummary(by = ecig, percent = "col", 
                 include = c(RIAGENDR,RIDAGEYR,RIDRETH3,merit,inc ,alc, LBXBPB,BMXBMI),
                 statistic = list(all_categorical()~"{n_unweighted}/{N_unweighted} ({p_unweighted}%)",
                                  all_continuous() ~ "{mean} ({mean.std.error})"),
                 label = list(RIAGENDR ~ "Gender",
                              RIDAGEYR ~ "Age (yrs)",
                              RIDRETH3 ~ "Race/Ethnicity",
                              merit ~ "Marital Status",
                              inc ~ "Household Income Level",
                              LBXBPB ~ "Blood Lead Level (ug/dL)",
                              BMXBMI ~ "BMI"),
                 missing_text = "Missing",
                 #missing = "no",
                 digits = list(RIDAGEYR ~ c(1, 1),
                               LBXBPB ~ c(1, 1),
                               BMXBMI ~ c(1,1)),
                 
                 )

```




### models
```{r results='asis'}
# unadjusted
model_unadjusted <- svyglm(LBXBPB~SMQ905, design = design_m)
sum_a <- model_unadjusted %>% tbl_regression()


# adjusted
model_adjusted <- svyglm(LBXBPB~SMQ905 + RIAGENDR + RIDAGEYR, design = design_m)
sum_b <- model_adjusted %>%  tbl_regression()


# interaction
model_sex <- svyglm(LBXBPB~SMQ905*RIAGENDR, design = design_m)
sum_c <- model_sex %>%  tbl_regression()

model_age <- svyglm(LBXBPB~SMQ905*RIDAGEYR, design = design_m)
sum_d <- model_age %>%  tbl_regression()


# summary
tbl_merge_sum <-
  tbl_stack(
    tbls = list(sum_a, sum_b, sum_c, sum_d),
    group_header = c("Unadjusted Analysis", "Adjusted Analysis", "Interaction-Gender", "Interaction-Age")
  )
tbl_merge_sum
```

### vaping-only subpopulation
```{r}
# design_v <- subset(design_m, )
```

