---
title: "code"
author: "Tuo Liu, Ran Wei, Yujung Chen"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---


### environment setup if needed
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(DataExplorer, dplyr, arsenal)
```

### Data read-in
### 3 Numeric criteria to get healthy participants
```{r}
# read in data & create PRE variable
data <- read.csv("./data/frmgham.csv") %>% mutate(PRE = ifelse(PREVCHD+PREVAP+PREVMI+PREVSTRK+PREVHYP+DIABETES >= 1, 1, 0))
```


### Data Preparation
```{r}
# filtration: healthy smoker at exam (1-2, 1-3)
period1 <- data %>% filter(PERIOD==1)
period2 <- data %>% filter(PERIOD==2)
period3 <- data %>% filter(PERIOD==3)

# healthy: using other numeric criteria results in o observation
healthy_current_smoker_p1 <- period1 %>% filter(CURSMOKE == 1 & PRE == 0)
healthy_current_smoker_p2 <- period2 %>% filter(RANDID %in% healthy_current_smoker_p1$RANDID) # forget about the name
healthy_current_smoker_p3 <- period3 %>% filter(RANDID %in% healthy_current_smoker_p1$RANDID) # forget about the name

# data
period_1 <- healthy_current_smoker_p1
period_2 <- healthy_current_smoker_p2
period_3 <- healthy_current_smoker_p3


# data type transformation
period_2$SEX <- as.factor(period_2$SEX)
period_2$PERIOD <- as.factor(period_2$PERIOD)
period_2$CURSMOKE <- as.factor(period_2$CURSMOKE)
period_2$CVD <- as.factor(period_2$CVD)


period_3$SEX <- as.factor(period_3$SEX)
period_3$PERIOD <- as.factor(period_3$PERIOD)
period_3$CURSMOKE <- as.factor(period_3$CURSMOKE)
period_3$CVD <- as.factor(period_3$CVD)

```




### Data Explorative Analysis
```{r results="asis"}
# filtration on original data
period_123 <- rbind(period_1, period_2, period_3)
# variabel type
DataExplorer::plot_missing(period_123)
DataExplorer::plot_qq(period_123[,c("AGE", "BMI", "SYSBP", "DIABP", "TOTCHOL")])

# descriptive statistics for table 1
my_labels <- list(
  CVD = "CVD Status",
  PERIOD = "Examination Cycle",
  CURSMOKE = "Current Smoker",
  CIGPDAY = "Cigarettes per day"
)
# attr(data$SEX,'label')  <- 'Gender'
# attr(data$PERIOD,'label')  <- 'Examination Cycle'
# attr(data$CVD,'label')  <- 'CVD Status'


my_controls <- tableby.control(
  test = T,
  total = F,
  numeric.test = "anova", cat.test = "chisq",
  numeric.stats = c("meansd", "medianq1q3", "Nmiss2"),
  cat.stats = c("countpct", "Nmiss2"),
  stats.labels = list(
    meansd = "Mean (SD)",
    medianq1q3 = "Median (Q1, Q3)",
    Nmiss2 = "Missing"
  )
)

table <- arsenal::tableby(interaction(PERIOD, CVD) ~  SEX + CURSMOKE + CIGPDAY + AGE + BMI + SYSBP + DIABP + TOTCHOL, data = period_123, control = my_controls)

summary(table,
  labelTranslations = my_labels,
  title = "Summary Statistic of Framingham Heart Study Longitudinal Data", 
  pfootnote=TRUE,
  results="asis",
  digits=1
)
```


### Model Build
Logistic Regression
Provides the following unique features:
* Hosmer-Lemeshow test of goodness of fit for the model
* Stepwise analyses
* Contrasts to define model parameterization
* Alternative cut points for classification
* Classification plots
* Model fitted on one set of cases to a held-out set of cases
* Saves predictions, residuals, and influence statistics


- check on class bias
- resample if bias is found
```{r}
# class bias
table(period_2$CVD)

# logistic regression
# backwards selection, interactions, confounding?
```


### Model Diagnostics
```{r}
# assess assumptions of logi regre
# sensitivity analysis
```

